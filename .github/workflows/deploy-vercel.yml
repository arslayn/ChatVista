name: Simple Discord Updates with OpenRouter

on:
  push:
    branches: [ main ]

jobs:
  discord-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Get commit info
      id: commit_info
      run: |
        echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
        echo "hash=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT
        echo "files=$(git diff --name-only HEAD~1 HEAD | tr '\n' ', ')" >> $GITHUB_OUTPUT
    
    - name: Generate AI Update Message
      id: ai_update
      run: |
        AI_RESPONSE=$(curl -s -X POST "https://openrouter.ai/api/v1/chat/completions" \
          -H "Authorization: Bearer ${{ secrets.OPENROUTER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "model": "openai/gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "Create a brief, engaging Discord message (100 words max) about this code update for Arslans AI chat app. Use emojis and be friendly. Focus on user benefits."
              },
              {
                "role": "user", 
                "content": "Commit: ${{ steps.commit_info.outputs.message }}\nFiles: ${{ steps.commit_info.outputs.files }}\nBy: ${{ steps.commit_info.outputs.author }}"
              }
            ],
            "max_tokens": 150
          }')
        
        AI_MESSAGE=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content')
        echo "message=$AI_MESSAGE" >> $GITHUB_OUTPUT
    
    - name: Post to Discord
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{
               \"embeds\": [{
                 \"title\": \"ü§ñ AI Chat App Updated!\",
                 \"description\": \"${{ steps.ai_update.outputs.message }}\",
                 \"color\": 5814783,
                 \"fields\": [
                   {\"name\": \"Commit\", \"value\": \"\`${{ steps.commit_info.outputs.hash }}\`\", \"inline\": true},
                   {\"name\": \"Author\", \"value\": \"${{ steps.commit_info.outputs.author }}\", \"inline\": true}
                 ],
                 \"footer\": {\"text\": \"Built by Arslan with ‚ù§Ô∏è\"},
                 \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
               }]
             }" \
             "${{ secrets.DISCORD_WEBHOOK }}"
